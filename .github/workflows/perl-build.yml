name: perl-build
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Perl
      uses: shogo82148/actions-setup-perl@v1
      with:
        perl-version: '5.34'
        working-directory: perl

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libmysqlclient-dev

    - name: Install dependencies
      run: |
        cpanm Dist::Zilla Archive::Tar::Wrapper
        cpanm https://github.com/bystrogenomics/msgpack-perl.git
        cpanm --force MouseX::Getopt
        git clone --recurse-submodules https://github.com/salortiz/LMDB_File.git \
          && cd LMDB_File \
          && perl Makefile.PL \
          && make test \
          && make install && rm -rf /app/LMDB_File
        dzil authordeps | cpanm

    - name: Run tests
      run: |
        dzil build --no-tgz .
